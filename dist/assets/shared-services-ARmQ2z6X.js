class x{constructor(t,e,s={}){this.key=t,this.value=e,this.createdAt=Date.now(),this.lastAccessedAt=Date.now(),this.accessCount=0,this.ttl=s.ttl||6e4,this.tags=s.tags||[],this.etag=s.etag||null}isExpired(){return Date.now()-this.createdAt>this.ttl}access(){return this.lastAccessedAt=Date.now(),this.accessCount++,this.value}}class A{constructor(t={}){this.maxEntries=t.maxEntries||100,this.defaultTTL=t.defaultTTL||6e4,this.cache=new Map,this.tagIndex=new Map,this.stats={hits:0,misses:0,evictions:0,invalidations:0}}get(t){const e=this.cache.get(t);return e?e.isExpired()?(this._remove(t),this.stats.misses++,null):(this.stats.hits++,this.cache.delete(t),this.cache.set(t,e),e.access()):(this.stats.misses++,null)}set(t,e,s={}){for(this.cache.has(t)&&this._remove(t);this.cache.size>=this.maxEntries;)this._evictLRU();const a=new x(t,e,{ttl:s.ttl||this.defaultTTL,tags:s.tags||[],etag:s.etag||null});return this.cache.set(t,a),a.tags.forEach(n=>{this.tagIndex.has(n)||this.tagIndex.set(n,new Set),this.tagIndex.get(n).add(t)}),a}has(t){const e=this.cache.get(t);return e?e.isExpired()?(this._remove(t),!1):!0:!1}invalidate(t){this._remove(t),this.stats.invalidations++}invalidateByTag(t){const e=this.tagIndex.get(t);if(!e)return 0;let s=0;return e.forEach(a=>{this._remove(a),s++}),this.tagIndex.delete(t),this.stats.invalidations+=s,s}invalidateByPattern(t){const e=new RegExp(t);let s=0;const a=[];return this.cache.forEach((n,h)=>{e.test(h)&&a.push(h)}),a.forEach(n=>{this._remove(n),s++}),this.stats.invalidations+=s,s}getStale(t){const e=this.cache.get(t);return e?e.value:null}getEtag(t){const e=this.cache.get(t);return(e==null?void 0:e.etag)||null}clear(){this.cache.clear(),this.tagIndex.clear()}getStats(){const t=this.stats.hits+this.stats.misses>0?(this.stats.hits/(this.stats.hits+this.stats.misses)*100).toFixed(1):"0.0";return{...this.stats,hitRate:`${t}%`,size:this.cache.size,maxSize:this.maxEntries}}_remove(t){const e=this.cache.get(t);e&&(e.tags.forEach(s=>{const a=this.tagIndex.get(s);a&&(a.delete(t),a.size===0&&this.tagIndex.delete(s))}),this.cache.delete(t))}_evictLRU(){const t=this.cache.keys().next().value;t!==void 0&&(this._remove(t),this.stats.evictions++)}}class I{constructor(t){this.cache=t,this.mutationRules=new Map}registerMutationRule(t,e,s){const a=`${t}:${e}`;this.mutationRules.set(a,s)}onMutation(t,e,s={}){const a=`${t}:${e}`,n=this.mutationRules.get(a);if(n){let h=0;return n.forEach(o=>{const r=typeof o=="function"?o(s):o;h+=this.cache.invalidateByTag(r)}),h}return 0}invalidateEntity(t,e){const s=`${t}:${e}`;return this.cache.invalidateByTag(s)}invalidateCollection(t){return this.cache.invalidateByTag(`collection:${t}`)}}async function $(i,t,e,s={}){const a=i.get(t);if(a!==null)return{data:a,source:"cache",stale:!1};const n=await e();return i.set(t,n,s),{data:n,source:"network",stale:!1}}async function L(i,t,e,s={}){try{const a=await e();return i.set(t,a,s),{data:a,source:"network",stale:!1}}catch(a){const n=i.getStale(t);if(n!==null)return{data:n,source:"cache",stale:!0,error:a};throw a}}function S(i,t,e,s={}){const a=i.getStale(t),n=i.has(t);let h=null;const o=e().then(r=>(i.set(t,r,s),s.onRevalidated&&s.onRevalidated(r),r)).catch(r=>(h=r,s.onRevalidateError&&s.onRevalidateError(r),null));return a!==null?{data:a,source:"cache",stale:!n,revalidating:o}:o.then(r=>{if(r===null)throw h||new Error("Network request failed and no cached data available");return{data:r,source:"network",stale:!1,revalidating:null}})}const y="/api",T=3,R=1e3,g=new Map;class m extends Error{constructor(t,e,s=null){super(t),this.name="ApiError",this.status=e,this.data=s}}class p extends m{constructor(t,e){super(`Rate limited. Retry after ${t}s`,429,e),this.name="RateLimitError",this.retryAfter=t}}async function _(i,t={}){const{method:e="GET",body:s=null,headers:a={},baseUrl:n=y,retry:h=!0,maxRetries:o=T,deduplicate:r=!0,signal:d=null,version:c="v1"}=t,u=`${n}/${c}${i}`,l=e==="GET"&&r&&!d;if(l){const E=g.get(u);if(E)return E}const f=v(u,{method:e,body:s,headers:a,signal:d,retry:h,maxRetries:o,attempt:0});return l&&(g.set(u,f),f.then(()=>g.delete(u),()=>g.delete(u))),f}async function v(i,t){const{method:e,body:s,headers:a,signal:n,retry:h,maxRetries:o,attempt:r}=t,d={method:e,headers:{"Content-Type":"application/json",...a}};n&&(d.signal=n),s&&e!=="GET"&&(d.body=JSON.stringify(s));try{const c=await fetch(i,d);if(c.status===429){const l=parseInt(c.headers.get("Retry-After")||"5",10),f=await c.json().catch(()=>null);if(h&&r<o)return await w(Math.min(l,5)*1e3),v(i,{...t,attempt:r+1});throw new p(l,f)}if(c.status>=500&&h&&r<o){const l=R*Math.pow(2,r);return await w(l),v(i,{...t,attempt:r+1})}if(!c.ok){const l=await c.json().catch(()=>null);throw new m((l==null?void 0:l.error)||`Request failed with status ${c.status}`,c.status,l)}return await c.json()}catch(c){if(c.name==="AbortError"||c instanceof m)throw c;if(h&&r<o){const u=R*Math.pow(2,r);return await w(u),v(i,{...t,attempt:r+1})}throw new m(c.message,0,null)}}function w(i){return new Promise(t=>setTimeout(t,i))}function C(i,t={}){return _(i,{...t,method:"GET"})}export{A as C,I as a,$ as c,C as g,L as n,S as s};
//# sourceMappingURL=shared-services-ARmQ2z6X.js.map
